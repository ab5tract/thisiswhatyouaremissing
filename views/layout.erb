<html>
<head>
  <title>thisiswhatyouaremissing.</title>
  <link rel="stylesheet" type="text/css" href="/css/chosen.css" />
  <link rel="stylesheet" type="text/css" href="/css/styles.css" />
  <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css" />
</head>
<body>
  <%= yield %>

  <div id="footer">
    <div id="footer-content">
      <div id="nav">
        <a href="/about" target="_blank">About</a>
        <a href="/visa" target="_blank">Get A Visa</a>
      </div>
      
      <div id="controls">
        <div id="select-container">
          <%= erb :select %>
        </div>

        <button id="main-button" class="btn btn-small btn-info">Cross Borders</button>
      </div>
    </div>
  </div>
</body>
</html>

<script type="text/javascript" src="/js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="/js/chosen.jquery.min.js"></script>
<script>
  // jQuery
  $('.chzn-select').chosen({
    allow_single_deselect: true,
    no_results_text:       "No results matched"
  });

  $('select').val(sessionStorage.getItem('country'));
  $('.chzn-select').trigger('liszt:updated');

  $('#main-button').click(function () {
    sessionStorage.setItem('country', $('select').val());
    restartFetch();
  });

  // HELPERS
  var randomIdx = function (int) {
    return Math.floor(Math.random()*int);
  };

  var popRandom = function (array) {
    return array.splice(randomIdx(array.length),1);
  };

  var initVacancies = function () {
    var arr = [];
    for (var i = 0; i < $('.slot').length; i+=1) { arr.push(i); }

    return arr;
  };

  // COUNTRY
  var getCountry = function () {
    var country = sessionStorage.getItem('country');

    return country == "" ? null : country;
  };

  // SEARCH WORDS
  var searchWords = <%= yield_content :script %>;
  var wordsLength = searchWords.length;

  var getRandomSearchWord = function () {
    return searchWords[randomIdx(wordsLength)];
  };

  // RESULTS
  var restartFetch = function () {
    $('.slot').html('');
    vacancies = initVacancies();
    fetch();
  };

  var requestData = {};
  var vacancies   = initVacancies();

  var fetch = function () {
    requestData['page']    = randomIdx(20) + 1;
    requestData['query']   = getRandomSearchWord();
    requestData['country'] = getCountry() || "<%= @country %>";

    $.getJSON('/fetch', requestData, function (responseData) {
      $.each(responseData, function (idx, video) {
        if (vacancies.length > 0) {
          var slotId = popRandom(vacancies);

          $('#' + slotId).html(video);
        }
      });
      if (vacancies.length > 0) { fetch(); }
    });
  };

  fetch();
</script>