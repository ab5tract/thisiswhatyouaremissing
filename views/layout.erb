<html>
<head>
  <title>thisiswhatyouaremissing</title>
  <link rel="stylesheet" type="text/css" href="/styles.css" />
  <script type="text/javascript" src="/jquery-1.7.1.min.js"></script>
  <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=<%= ENV['GMAPS_API_KEY'] %>&sensor=true"></script>
</head>
<body>
  <%= yield %>
</body>
</html>

<script>
  var vacancies = [];
  for (i = 0; i < 16; i++) { vacancies.push(i); }

  var fetch = function (country) {
    var param       = <% if @country %>"<%= @country %>"<% else %> country <% end %>;
    var query_param = param == undefined || param == '' ? '' : '?country=' + param;

    $.getJSON('/fetch' + query_param, function (data) {
      $.each(data, function (idx, video) {
        if (vacancies.length > 0) {
          $('#' + vacancies.splice(Math.floor(Math.random()*vacancies.length),1)).html(video);
        }
      });
      if (vacancies.length > 0) { fetch(country); }
    });
  };

  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(function(pos) {
      var geocoder = new google.maps.Geocoder();
      var latLng   = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);

      geocoder.geocode({ latLng: latLng }, function (results, status) {
        var country = ($.grep(results[0].address_components, function(component) {
          return component.types.indexOf("country") != -1;
        }) || [{ short_name: undefined }])[0].short_name;

        fetch(country);
      });
    });
  }
</script>